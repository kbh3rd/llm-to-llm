<!DOCTYPE html>
<html lang="en">
<!-- $Revision: 1.18 $ -->
<!-- $Locker:  $ -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM-to-LLM Conversation Orchestrator</title>
    <style>
        body {
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
        }
        textarea, input, select, button {
            background-color: #2d2d2d;
            color: #ffffff;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .sysPromptArea {
            display: inline-block;
            width: 49%;
        }
        #systemPromptArea1 {
            float: left;
        }
        #systemPromptArea2 {
            float: right;
        }
        #buttonArea {
            clear: both;
        }
        button {
            cursor: pointer;
            background-color: #007bff;
            border: none;
        }
        #startButton {
            background-color: green;
        }
        #continueButton {

        }
        #stopButton {
            background-color: red;
            color: white;
        }
        #clearButton {
            background-color: brown;
            color: white;
        }
        .cmdButton {
            width: 8em;
        }
        #startButton:hover {
            background-color: darkgreen;
        }
        #stopButton:hover, #clearButton:hover {
            background-color: darkred;
        }
        button:hover {
            background-color: #0056b3;
        }
        .conversation {
            border: 1px solid #444;
            padding: 10px;
            margin-top: 10px;
            height: 400px;
            overflow-y: auto;
            background-color: #252526;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .user-message {
            background-color: #3a3a3a;
        }
        .llm1-message {
            background-color: #2a4d69;
        }
        .llm2-message {
            background-color: #4a2c69;
        }
        label {
            margin-top: 10px;
            display: block;
            color: lightgreen ;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>LLM-to-LLM Conversation Orchestrator</h1>

        <div>
            <div id="systemPromptArea2" class="sysPromptArea">
                <label for="systemPrompt2">System Prompt for LLM 2:</label>
                <textarea class="sysPrompt" id="systemPrompt2" rows="3">You masquerade as a friendly and inquisitive user engaged in a conversation with an AI chatbot. You play the role of the user; you are not the assistant. You limit your output to 150 words or less per round.</textarea>
            </div>

            <div id="systemPromptArea1" class="sysPromptArea">
                <label for="systemPrompt1">System Prompt for LLM 1:</label>
                <textarea class="sysPrompt" id="systemPrompt1" rows="3">This is a conversation between User and Llama, a friendly chatbot assistant. Llama is helpful, kind, honest, good at writing, and never fails to answer any requests immediately and with precision. You limit your output to 150 words or less per round.</textarea>
            </div>

        </div>

        <div>
            <div style="float:left; width: 49%;">
            <label for="conversationLength">Conversation Length (number of exchanges):</label>
            <input type="number" id="conversationLength" min="1" value="5">
            </div>

            <div style="float:right; width: 49%;">
            <label for="initialLLM">Send Initial Prompt to:</label>
            <select id="initialLLM">
                <option value="llm1">LLM 1</option>
                <option value="llm2">LLM 2</option>
            </select>
            </div>
        </div>

        <label for="initialPrompt">Initial Prompt:</label>
        <textarea id="initialPrompt" rows="4" placeholder="Enter the initial prompt"></textarea>

        <div id="buttonArea">
            <button id="startButton" class="cmdButton" onclick="startConversation()">Start</button>
            <button id="continueButton" class="cmdButton" onclick="continueConversation()">Continue</button>
            <button id="stopButton" class="cmdButton" onclick="interruptConversation()">Interrupt</button>
            <button id="clearButton" class="cmdButton" onclick="clearConversation()">Clear</button>
        </div>

        <div class="conversation" id="conversation">
            <!-- Conversation messages will appear here -->
        </div>
    </div>

    <script>
        let conversationActive = false;
        let conversationHistory1 = [];
        let conversationHistory2 = [];
        let currentExchangeCount = 0;
        let maxExchanges = 5;
        let lastLLM = null; // Track the last LLM that responded
        let lastPrompt = null; // Track the last prompt used
        let abortController = null;
        let serverURL1 = "http://localhost:8080/completion";
        let serverURL2 = "http://localhost:8081/completion";

        function formatMessage(role, content, llmId) {
            return `<|start_header_id|>${role}<|end_header_id>\n${content}<|eot_id>\n`;
        }

        function displayMessage(content, sender) {
            const conversationDiv = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.textContent = content;
            conversationDiv.appendChild(messageDiv);
            conversationDiv.scrollTop = conversationDiv.scrollHeight;
        }

        function renderMarkdown(markdownText) {

            // Convert markdown to HTML
            let html = markdownText
                // Paragraphs (two newlines)
                .replace(/\n\n+/g, '</p><p>')
                // Single newlines within paragraphs
                .replace(/\n/g, '<br>')
                // Headings (#, ##, ###)
                .replace(/^### (.*)$/gm, '<h3>$1</h3>')
                .replace(/^## (.*)$/gm, '<h2>$1</h2>')
                .replace(/^# (.*)$/gm, '<h1>$1</h1>')
                // Bold (**text** or __text__)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/__(.*?)__/g, '<strong>$1</strong>')
                // Italic (*text* or _text_)
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/_(.*?)_/g, '<em>$1</em>')
                // Code blocks (```code```)
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                // Unordered lists (- or * at start of line)
                .replace(/^[-*] (.*)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
                // Ordered lists (1. at start of line)
                .replace(/^\d+\. (.*)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>\n?)+/g, '<ol>$&</ol>');

            // Wrap content in paragraph tags if not already wrapped
            html = `<p>${html}</p>`;
            
            // Clean up any empty paragraphs and consecutive breaks
            html = html
                .replace(/<p>\s*<\/p>/g, '')
                .replace(/(<br>)+/g, '<br>');

            // Set the HTML content
            return html.trim();
        }


        async function sendToLLM(prompt, history, systemPrompt, llmId) {
            if (!conversationActive) return null;

            const fullPrompt = `<|begin_of_text|>${formatMessage('system', systemPrompt)}${history.join('')}${formatMessage('user', prompt)}<|start_header_id|>assistant<|end_header_id>\n`;
            abortController = new AbortController();
            const responseDiv = document.createElement('div');
            responseDiv.className = `message ${llmId}-message`;
            document.getElementById('conversation').appendChild(responseDiv);
            document.getElementById('conversation').scrollTop = document.getElementById('conversation').scrollHeight;

            let buffer = '';
            let result = '';

            const currentUrl = llmId === "llm1" ? serverURL1 : serverURL2;

            try {
                const response = await fetch(currentUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt, stream: true }),
                    signal: abortController.signal
                });

                const reader = response.body.getReader();
                while (conversationActive) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    // Decode the chunk and append to buffer
                    buffer += new TextDecoder().decode(value);

                    // Process complete lines
                    let newlineIndex;
                    while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
                        const line = buffer.slice(0, newlineIndex).trim();
                        buffer = buffer.slice(newlineIndex + 1);

                        if (line.startsWith('data: ')) {
                            const jsonString = line.slice(6);
                            // Only parse if the JSON string appears complete
                            if (jsonString && jsonString.endsWith('}')) {
                                try {
                                    const data = JSON.parse(jsonString);
                                    if (data.content) {
                                        result += data.content;
                                        result = result.replace(/<\|[^>]*>/g, ''); // Remove trailing cruft
                                        // responseDiv.textContent = result;
                                        responseDiv.innerHTML = renderMarkdown(result);
                                        document.getElementById('conversation').scrollTop = document.getElementById('conversation').scrollHeight;
                                    }
                                } catch (error) {
                                    console.error('JSON Parse Error:', error, 'Line:', jsonString);
                                    // Continue processing; skip invalid JSON
                                }
                            } else {
                                // Incomplete JSON; append back to buffer and wait for more data
                                buffer = line + '\n' + buffer;
                            }
                        }
                    }
                }
                return result;
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request aborted');
                    return null;
                }
                console.error('Error:', error);
                return null;
            }
        }

        async function startConversation() {
            if (conversationActive) return;
            clearConversation();
            conversationActive = true;
            currentExchangeCount = 0;
            conversationHistory1 = [];
            conversationHistory2 = [];
            lastLLM = null;
            lastPrompt = null;
            maxExchanges = parseInt(document.getElementById('conversationLength').value) || 5;
            const initialPrompt = document.getElementById('initialPrompt').value;
            const initialLLM = document.getElementById('initialLLM').value;
            const systemPrompt1 = document.getElementById('systemPrompt1').value;
            const systemPrompt2 = document.getElementById('systemPrompt2').value;

            displayMessage(initialPrompt, 'user');
            let currentLLM = initialLLM;
            let currentPrompt = initialPrompt;

            // Initialize history for the other LLM with a dummy "Hello" user prompt and the initial prompt as its own response
            if (initialLLM === 'llm1') {
                conversationHistory2.push(formatMessage('user', 'Hello'), formatMessage('assistant', initialPrompt));
            } else {
                conversationHistory1.push(formatMessage('user', 'Hello'), formatMessage('assistant', initialPrompt));
            }

            while (conversationActive && currentExchangeCount < maxExchanges) {
                const history = currentLLM === 'llm1' ? conversationHistory1 : conversationHistory2;
                const systemPrompt = currentLLM === 'llm1' ? systemPrompt1 : systemPrompt2;
                const response = await sendToLLM(currentPrompt, history, systemPrompt, currentLLM);
                if (!response || !conversationActive) break;

                // Update histories
                if (currentLLM === 'llm1') {
                    conversationHistory1.push(formatMessage('user', currentPrompt), formatMessage('assistant', response));
                    conversationHistory2.push(formatMessage('user', response));
                } else {
                    conversationHistory2.push(formatMessage('user', currentPrompt), formatMessage('assistant', response));
                    conversationHistory1.push(formatMessage('user', response));
                }

                lastLLM = currentLLM;
                lastPrompt = response;
                currentPrompt = response;
                currentLLM = currentLLM === 'llm1' ? 'llm2' : 'llm1';
                currentExchangeCount++;
            }
            conversationActive = false;
        }

        async function continueConversation() {
            if (conversationActive) return;
            if (!lastLLM || !lastPrompt) {
                alert('No previous conversation to continue. Please start a new conversation.');
                return;
            }

            conversationActive = true;
            maxExchanges = parseInt(document.getElementById('conversationLength').value) || 5;
            const systemPrompt1 = document.getElementById('systemPrompt1').value;
            const systemPrompt2 = document.getElementById('systemPrompt2').value;

            let currentLLM = lastLLM === 'llm1' ? 'llm2' : 'llm1'; // Start with the other LLM
            let currentPrompt = lastPrompt;
            let additionalExchanges = 0;

            while (conversationActive && additionalExchanges < maxExchanges) {
                const history = currentLLM === 'llm1' ? conversationHistory1 : conversationHistory2;
                const systemPrompt = currentLLM === 'llm1' ? systemPrompt1 : systemPrompt2;
                const response = await sendToLLM(currentPrompt, history, systemPrompt, currentLLM);
                if (!response || !conversationActive) break;

                // Update histories
                if (currentLLM === 'llm1') {
                    conversationHistory1.push(formatMessage('user', currentPrompt), formatMessage('assistant', response));
                    conversationHistory2.push(formatMessage('user', response));
                } else {
                    conversationHistory2.push(formatMessage('user', currentPrompt), formatMessage('assistant', response));
                    conversationHistory1.push(formatMessage('user', response));
                }

                lastLLM = currentLLM;
                lastPrompt = response;
                currentPrompt = response;
                currentLLM = currentLLM === 'llm1' ? 'llm2' : 'llm1';
                additionalExchanges++;
                currentExchangeCount++;
            }
            conversationActive = false;
        }

        function interruptConversation() {
            conversationActive = false;
            if (abortController) {
                abortController.abort();
                abortController = null;
            }
        }

        function clearConversation() {
            interruptConversation();
            document.getElementById('conversation').innerHTML = '';
            conversationHistory1 = [];
            conversationHistory2 = [];
            currentExchangeCount = 0;
            lastLLM = null;
            lastPrompt = null;
        }
    </script>
</body>
</html>
